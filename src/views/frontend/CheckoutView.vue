<template>
  <div>
    <PageLoading v-if="isLoading"></PageLoading>
    <div
      v-else
      class="container bg-main-medium container-rounded my-5 py-7r px-lg-5 px-md-4 px-sm-3"
    >
      <!-- Â§ßÊ®ôÈ°å -->
      <div class="d-flex align-items-center justify-content-center mb-3">
        <h2 class="text-center border-secondary pb-2 fw-bold">ÁµêÂ∏≥</h2>
      </div>
      <!-- Ë©≥Á¥∞ÂÖßÂÆπ -->
      <div class="row row-cols-1 row-cols-lg-2">
        <!-- Ë©≥Á¥∞ÂÖßÂÆπÂ∑¶ -->
        <div class="col">
          <div class="accordion">
            <!-- Ë≥ºÁâ©Ëªä -->
            <BasicCollapse :uniqueId="'ShoppingCartSection'" :open="true">
              <template v-slot:header> Ë≥ºÁâ©Ëªä </template>
              <template v-slot:body>
                <div class="" v-if="cartsData.length === 0">
                  <p>ÁõÆÂâçË≥ºÁâ©ËªäÂÖßÊ≤íÊúâÁî¢ÂìÅ üòÑ</p>
                  <RouterLink
                    :to="{ name: 'products', query: { category: 'ÂÖ®ÈÉ®Áî¢ÂìÅ' } }"
                    class="btn btn-solid-spec w-100 btn-lg"
                  >
                    ÁπºÁ∫åË≥ºÁâ©
                  </RouterLink>
                </div>
                <div v-else class="">
                  <div class="row mb-3 position-relative" v-for="item in cartsData" :key="item.id">
                    <VueLoading
                      :active="item.product.id === isSmLoading || item.id === isSmLoading"
                      :is-full-page="false"
                      :color="'#52504B'"
                    >
                    </VueLoading>
                    <div
                      class="col col-sm-2 col-lg-3 d-flex align-items-center justify-content-center"
                    >
                      <img
                        role="button"
                        @click="changeToProductPage(item.product.id, item.product.category)"
                        :src="item.product.imageUrl"
                        :alt="item.product.title"
                        class="img-fluid"
                        width="150"
                      />
                    </div>
                    <div class="col col-sm-10 col-lg-9">
                      <div class="d-flex justify-content-between">
                        <h6
                          class="text-link-deep-gray"
                          role="button"
                          @click="changeToProductPage(item.product.id, item.product.category)"
                        >
                          {{ item.product.title }}
                        </h6>
                        <button
                          type="button"
                          class="btn-close"
                          aria-label="Close"
                          @click="goToDeleteCart(item.id)"
                        ></button>
                      </div>
                      <p>
                        ÂñÆÂÉπNT$ {{ parseInt(item.product.price) }} / Â∞èË®àNT$
                        {{ parseInt(item.total) }}
                        <span v-if="item.final_total !== item.total">
                          /ÂÑ™ÊÉ†ÂÉπNT$ {{ parseInt(item.final_total) }}
                        </span>
                      </p>

                      <QuantityControlButtons
                        :inventory="item.product.inventory"
                        :id="item.product_id"
                        :qty="item.qty"
                        :product-cart-id="item.id"
                        @put-num="goToPutCart"
                      >
                      </QuantityControlButtons>
                    </div>
                  </div>
                  <!-- Ê∏ÖÁ©∫Ë≥ºÁâ©ËªäÊåâÈàï -->
                  <div class="d-flex mb-3" v-if="cartsData.length > 1">
                    <button
                      type="button"
                      class="btn btn-outline-mdgray w-100"
                      @click="goToDeleteCarts"
                    >
                      Ê∏ÖÁ©∫Ë≥ºÁâ©Ëªä
                    </button>
                  </div>
                </div>
              </template>
            </BasicCollapse>
            <!-- Ë®ÇÂñÆÁ¢∫Ë™ç -->
            <BasicCollapse
              v-if="cartsData.length !== 0"
              :uniqueId="'OrderConfirmationSection'"
              :open="true"
            >
              <template v-slot:header> Ë®ÇÂñÆÁ¢∫Ë™ç </template>
              <template v-slot:body>
                <!-- Áî¢ÂìÅÁ∏ΩÈáëÈ°ç -->
                <div class="d-flex justify-content-between">
                  <p>Áî¢ÂìÅÁ∏ΩÈáëÈ°ç</p>
                  <p>NT$ {{ parseInt(allCartsData.total) }}</p>
                </div>
                <!-- ÈÅãË≤ª -->
                <div class="d-flex justify-content-between">
                  <p>ÈÅãË≤ª</p>
                  <p>ÂÖçÈÅãË≤ª</p>
                </div>
                <div v-if="!allCartsData.useCoupon">
                  <!-- ‰ΩøÁî®ÂÑ™ÊÉ†‰ª£Á¢º1 -->
                  <div class="d-flex justify-content-between" v-if="!useCoupon">
                    <p>ÂÑ™ÊÉ†‰ª£Á¢º</p>
                    <button type="button" class="btn btn-outline-dpgray" @click="useCoupon = true">
                      ‰ΩøÁî®ÂÑ™ÊÉ†‰ª£Á¢º
                    </button>
                  </div>
                  <!-- ‰ΩøÁî®ÂÑ™ÊÉ†‰ª£Á¢º2 -->
                  <div class="mb-3" v-else-if="useCoupon">
                    <p class="w-25">ÂÑ™ÊÉ†‰ª£Á¢º</p>
                    <div class="d-flex justify-content-between align-items-center">
                      <input
                        type="text"
                        class="form-control"
                        id="category"
                        placeholder="Ë´ãÂ°´ÂÖ•ÂÑ™ÊÉ†‰ª£Á¢º"
                        v-model="couponCode"
                      />
                      <button
                        type="button"
                        class="w-25 btn btn-outline-dpgray ms-3"
                        @click="goToPostCoupon"
                      >
                        ‰ΩøÁî®
                      </button>
                      <button
                        type="button"
                        class="w-25 btn btn-outline-dpgray ms-3"
                        @click="useCoupon = false"
                      >
                        ÂèñÊ∂à
                      </button>
                    </div>
                  </div>
                </div>
                <!-- ‰ΩøÁî®ÂÑ™ÊÉ†‰ª£Á¢º3 -->
                <div class="d-flex justify-content-between" v-if="allCartsData.useCoupon">
                  <p>‰ΩøÁî®ÂÑ™ÊÉ†Âà∏</p>
                  <p>
                    ÂÑ™ÊÉ† NT$
                    {{ parseInt(allCartsData.total, 10) - parseInt(allCartsData.final_total, 10) }}
                  </p>
                </div>
                <hr />
                <!-- Á∏Ω‰ªòÊ¨æÈáëÈ°ç -->
                <div class="d-flex justify-content-between" v-if="!allCartsData.useCoupon">
                  <p>Á∏Ω‰ªòÊ¨æÈáëÈ°ç</p>
                  <h4 class="text-end text-main-spec">
                    NT$
                    <strong class="fs-3">{{ parseInt(allCartsData.total) }}</strong>
                  </h4>
                </div>
                <!-- Á∏Ω‰ªòÊ¨æÈáëÈ°ç2 -->
                <div class="" v-else-if="allCartsData.useCoupon">
                  <div class="d-flex justify-content-between">
                    <p>Á∏Ω‰ªòÊ¨æÈáëÈ°ç</p>
                    <h5 class="text-decoration-line-through">
                      NT$ {{ parseInt(allCartsData.total) }}
                    </h5>
                  </div>
                  <h4 class="text-end text-main-spec">
                    NT$
                    <strong class="fs-3">{{ parseInt(allCartsData.final_total) }}</strong>
                  </h4>
                </div>
              </template>
            </BasicCollapse>
          </div>
        </div>
        <!-- Ë©≥Á¥∞ÂÖßÂÆπÂè≥ -->
        <div class="col">
          <div class="accordion">
            <!-- ËÅØÁµ°ÊàëÂÄë -->
            <ContactUsDetails v-if="cartsData.length === 0"></ContactUsDetails>
            <!-- Êî∂‰ª∂Ë≥áÊñô -->
            <BasicCollapse
              v-if="cartsData.length !== 0"
              :uniqueId="'RecipientInformationSection'"
              :open="true"
            >
              <template v-slot:header> Êî∂‰ª∂Ë≥áÊñô </template>
              <template v-slot:body>
                <vee-form ref="form" @submit="goToPostOrder" v-slot="{ errors }">
                  <!-- Êî∂‰ª∂‰∫∫ÂêçÁ®± -->
                  <div class="mb-3">
                    <label for="user" class="form-label"
                      >Êî∂‰ª∂‰∫∫ÂêçÁ®±
                      <span class="text-main-spec fw-bold">*</span>
                    </label>
                    <vee-field
                      type="text"
                      name="Êî∂‰ª∂‰∫∫"
                      class="form-control"
                      :class="{ 'is-invalid': errors['Êî∂‰ª∂‰∫∫'] }"
                      rules="required|max:15"
                      id="user"
                      placeholder="Ë´ãÂ°´ÂÖ•Êî∂‰ª∂‰∫∫ÁúüÂØ¶ÂßìÂêçÔºå‰ª•Á¢∫‰øùÈ†ÜÂà©Êî∂‰ª∂"
                      v-model="orderData.data.user.name"
                    ></vee-field>
                    <vee-error-message class="invalid-feedback" name="Êî∂‰ª∂‰∫∫"></vee-error-message>
                  </div>
                  <!-- ÈõªÂ≠ê‰ø°ÁÆ± -->
                  <div class="mb-3">
                    <label for="email" class="form-label"
                      >ÈõªÂ≠ê‰ø°ÁÆ±
                      <span class="text-main-spec fw-bold">*</span>
                    </label>
                    <vee-field
                      type="email"
                      class="form-control"
                      :class="{ 'is-invalid': errors['ÈõªÂ≠ê‰ø°ÁÆ±'] }"
                      id="email"
                      rules="email|required"
                      name="ÈõªÂ≠ê‰ø°ÁÆ±"
                      placeholder="Ë´ãÂ°´ÂÖ•Ë®ÇÂñÆÈÄöÁü•Email (Ë®ÇÂñÆË≥áË®äÂ∞á‰ª•Ê≠§E-mailÈÄöÁü•ÊÇ®)"
                      v-model="orderData.data.user.email"
                    ></vee-field>
                    <vee-error-message class="invalid-feedback" name="ÈõªÂ≠ê‰ø°ÁÆ±"></vee-error-message>
                  </div>
                  <!-- Ë°åÂãïÈõªË©±ËôüÁ¢º -->
                  <div class="mb-3">
                    <label for="phone" class="form-label"
                      >Ë°åÂãïÈõªË©±ËôüÁ¢º
                      <span class="text-main-spec fw-bold">*</span>
                    </label>
                    <vee-field
                      type="tel"
                      name="Ë°åÂãïÈõªË©±"
                      :rules="isPhone"
                      class="form-control"
                      :class="{ 'is-invalid': errors['Ë°åÂãïÈõªË©±'] }"
                      id="phone"
                      placeholder="Ë´ãÂ°´ÂÖ•Êî∂‰ª∂‰∫∫Ë°åÂãïÈõªË©±ËôüÁ¢º (‰æõÈÖçÈÄÅ‰∫∫Âì°ËÅØÁµ°)"
                      v-model="orderData.data.user.tel"
                    ></vee-field>
                    <vee-error-message class="invalid-feedback" name="Ë°åÂãïÈõªË©±"></vee-error-message>
                  </div>
                  <!-- Êî∂‰ª∂Âú∞ÂùÄ -->
                  <div class="mb-3">
                    <label for="address" class="form-label"
                      >Êî∂‰ª∂Âú∞ÂùÄ
                      <span class="text-main-spec fw-bold">*</span>
                    </label>
                    <vee-field
                      type="text"
                      name="Êî∂‰ª∂Âú∞ÂùÄ"
                      class="form-control"
                      :class="{ 'is-invalid': errors['Êî∂‰ª∂Âú∞ÂùÄ'] }"
                      id="address"
                      rules="required|max:100"
                      placeholder="ÈÄÅË≤®Âú∞ÈªûÁõÆÂâçÂÉÖÊèê‰æõÔºöÂè∞ÁÅ£„ÄÅÂè∞ÁÅ£Â§ñÂ≥∂ÂÆÖÈÖç"
                      v-model="orderData.data.user.address"
                    ></vee-field>
                    <vee-error-message class="invalid-feedback" name="Êî∂‰ª∂Âú∞ÂùÄ"></vee-error-message>
                  </div>
                  <!-- Ë®ÇÂñÆÂÇôË®ª -->
                  <div class="mb-3">
                    <label for="orderMessage" class="form-label">Ë®ÇÂñÆÂÇôË®ª</label>
                    <vee-field
                      as="textarea"
                      name="Ë®ÇÂñÆÂÇôË®ª"
                      class="w-100 form-control"
                      :class="{ 'is-invalid': errors['Ë®ÇÂñÆÂÇôË®ª'] }"
                      id="orderMessage"
                      rows="5"
                      placeholder="ÁÆ°ÁêÜÂÆ§‰ª£Êî∂/ÈõªË©±ËÅØÁµ°ÊôÇÈñì..."
                      rules="max:800"
                      v-model="orderData.data.message"
                    ></vee-field>
                    <vee-error-message class="invalid-feedback" name="Ë®ÇÂñÆÂÇôË®ª"></vee-error-message>
                  </div>
                  <!-- Ê≥®ÊÑè‰∫ãÈ†Ö -->
                  <div class="form-check mb-3">
                    <input
                      type="checkbox"
                      class="form-check-input"
                      id="is_enabled"
                      v-model="checkOrderInfo"
                    />
                    <label for="is_enabled" class="form-check-label">
                      <span class="text-main-spec fw-bold">ÊàëÂ∑≤Á¢∫Ë™ç‰ª•‰∏ãÂÖßÂÆπÔºö</span>
                      <span
                        ><br />ÊèêÈÜíÊÇ®ÔºåÈÄÅÂá∫Ë®ÇÂñÆÂæåÔºåÂ∞áÁÑ°Ê≥ï‰øÆÊîπË®ÇÂñÆÂÖßÂÆπÔºå‰∏¶ÂâçÂæÄ‰ªòÊ¨æÊµÅÁ®ãÔºåË´ãÊÇ®Á¢∫ÂÆöÁÑ°Ë™§ÂæåÂÜçÈÄÅÂá∫üòÑ</span
                      >
                    </label>
                  </div>
                  <!-- Â∞èÊèêÈÜí -->
                  <div class="bg-light-gray text-deep-gray px-3 py-2 mb-3">
                    <h6>ÂÖçÈÅãÊúçÂãô</h6>
                    <span
                      >ÊàëÂÄëÁöÑÁî¢ÂìÅ‰ªòÊ¨æÊé°Áî®„ÄåÁ∑ö‰∏ä‰ø°Áî®Âç°„Äç‰ªòÊ¨æÂæåÂá∫Ë≤®ÔºåÈÅãÈÄÅÊé°Áî®„ÄåÂÆÖÈÖçÂà∞Â∫ú„ÄçÂÖçÈÅãÊúçÂãôÔºåËÆìÊÇ®ËºïÈ¨ÜË≥ºË≤∑„ÄÅÂÆâÂøÉÊî∂Ë≤®„ÄÇ</span
                    >
                  </div>
                  <!-- ÁµêÂ∏≥ÊåâÈàï -->
                  <div class="d-flex mb-3">
                    <button
                      type="submit"
                      class="border btn btn-solid-spec w-100 btn-lg"
                      :disabled="!checkOrderInfo"
                    >
                      ÁµêÂ∏≥
                    </button>
                  </div>
                </vee-form>
              </template>
            </BasicCollapse>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>
<script>
import { mapActions, mapState } from 'pinia';
import ordersStore from '../../stores/ordersStore';
import cartsStore from '../../stores/cartsStore';
import toastsStore from '../../stores/toastsStore';
import pageStore from '../../stores/pageStore';
import alertStore from '../../stores/alertStore';
// component
import QuantityControlButtons from '../../components/QuantityControlButtons.vue';
import ContactUsDetails from '../../components/frontend/ContactUsDetails.vue';
import BasicCollapse from '../../components/frontend/BasicCollapse.vue';

export default {
  data() {
    return {
      // Áî®‰æÜÊéßÂà∂‰ΩøÁî®ÂÑ™ÊÉ†Âà∏ËàáÂê¶ÁöÑÂàáÊèõ
      useCoupon: false,
      // ÂÑ™ÊÉ†Âà∏‰ª£Á¢º
      couponCode: '',
      // ÊòØÂê¶ËßÄÁúãÈÄÅÂá∫Ë®ÇÂñÆÂâçÁöÑ‰∫ãÈ†Ö
      checkOrderInfo: false,
      // ÈÄÅÂá∫Ë®ÇÂñÆË≥áÊñô
      orderData: {
        data: {
          user: {
            name: null,
            email: null,
            tel: null,
            address: null,
          },
          message: null,
        },
      },
      // ÊòØÂê¶ÈÄÅÂá∫Ë®ÇÂñÆ Áî®‰æÜÊéßÂà∂ sessionStorage
      doesPostCart: false,
    };
  },
  components: {
    QuantityControlButtons,
    ContactUsDetails,
    BasicCollapse,
  },
  methods: {
    isPhone(value) {
      const phoneNumber = /^(09)[0-9]{8}$/;
      return phoneNumber.test(value) ? true : 'Ë´ãËº∏ÂÖ•Ê≠£Á¢∫ÁöÑË°åÂãïÈõªË©±ËôüÁ¢º';
    },
    // Ë∑≥ËΩâËá≥Áî¢ÂìÅË©≥Á¥∞È†ÅÈù¢
    changeToProductPage(id, category) {
      this.changeNowPage(category);
      this.$router.push({
        name: 'product',
        params: { id },
      });
    },
    async goToGetCart(boolean = true) {
      try {
        await this.getCart(boolean);
      } catch (err) {
        this.showAlertMessage(false, err.response.data.message);
      }
    },
    async goToPutCart(productCartId, productId, qty) {
      try {
        const res = await this.putCart(productCartId, productId, qty);
        await this.goToGetCart(false);
        this.pushToast({
          title: res.data.message,
          style: 'bg-deep-gray',
        });
      } catch (err) {
        this.showAlertMessage(false, err.response.data.message);
      }
    },
    async goToDeleteCart(productCartId) {
      try {
        const res = await this.deleteCart(productCartId);
        await this.goToGetCart(false);
        this.pushToast({
          title: res.data.message,
          style: 'bg-deep-gray',
        });
      } catch (err) {
        this.showAlertMessage(false, err.response.data.message);
      }
    },
    async goToDeleteCarts() {
      try {
        const res = await this.deleteCarts();
        await this.goToGetCart();
        this.pushToast({
          title: res.data.message,
          style: 'bg-deep-gray',
        });
      } catch (err) {
        this.showAlertMessage(false, err.response.data.message);
      }
    },
    async goToPostCoupon() {
      if (this.couponCode === '') {
        this.showAlertMessage(false, 'Ë´ãÂ°´ÂØ´ÂÑ™ÊÉ†Âà∏‰ª£Á¢º');
        return;
      }
      try {
        const res = await this.postCoupon(this.couponCode);
        await this.goToGetCart(false);
        this.pushToast({
          title: res.data.message,
          style: 'bg-deep-gray',
        });
      } catch (err) {
        this.showAlertMessage(false, err.response.data.message);
      }
    },
    async goToPostOrder() {
      // Áî®‰æÜÊéßÂà∂ sessionStorage
      this.doesPostCart = true;
      try {
        const res = await this.postOrder(this.orderData);
        this.$router.push({
          name: 'payment',
          params: { id: res.data.orderId },
        });
        // Á¢∫‰øù‰Ω†ÁöÑÈÇèËºØÂú®‰∏ã‰∏ÄÊ¨° DOM Êõ¥Êñ∞‰πãÂæåÂü∑Ë°åÔºåÈÅøÂÖçÊΩõÂú®ÁöÑ‰∏¶ÁôºÂïèÈ°å
        // ÊàëÁöÑÈÄô‰∫õÈÇèËºØÊúâÈóúÊñº domÁöÑÊõ¥Êñ∞ ÊâÄ‰ª•ÈúÄË¶ÅÁ¢∫‰øù ÊàëÁöÑÊìç‰ΩúË¶ÅÂú®DOMÊõ¥Êñ∞‰πãÂæåÂü∑Ë°å
        this.$nextTick(() => {
          // ÈÄÅÂá∫Ë®ÇÂñÆÊôÇÈáçÊñ∞ÂèñÂæóÊúÄÊñ∞Ë≥ºÁâ©ËªäÁãÄÊÖã
          this.goToGetCart(false);
          // ÈáçÁΩÆË°®ÂñÆ
          this.$refs.form.resetForm();
        });
      } catch (err) {
        this.showAlertMessage(false, err.response.data.message);
      }
    },
    ...mapActions(cartsStore, ['getCart', 'putCart', 'deleteCart', 'deleteCarts', 'postCoupon']),
    ...mapActions(ordersStore, ['postOrder']),
    ...mapActions(toastsStore, ['pushToast']),
    ...mapActions(pageStore, ['changeNowPage']),
    ...mapActions(alertStore, ['showAlertMessage']),
  },
  computed: {
    ...mapState(cartsStore, ['isLoading', 'isSmLoading', 'cartsData', 'allCartsData']),
  },
  mounted() {
    this.goToGetCart();
    if (window.sessionStorage.getItem('orderData')) {
      const orderData = window.sessionStorage.getItem('orderData');
      this.orderData = JSON.parse(orderData);
    }
  },
  beforeUnmount() {
    if (this.doesPostCart) {
      window.sessionStorage.removeItem('orderData');
    } else {
      const orderData = JSON.stringify(this.orderData);
      window.sessionStorage.setItem('orderData', orderData);
    }
  },
};
</script>

<style>
/* Chrome, Safari, Edge, Opera */
input::-webkit-outer-spin-button,
input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

/* Firefox */
input[type='number'] {
  -moz-appearance: textfield;
  appearance: textfield;
}
</style>
